<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a6286">
  <title>Install App</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .install-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--pwa-bg);
    }
    
    .install-header {
      background: var(--pwa-primary);
      color: #fff;
      padding: 1rem;
      padding-top: calc(1rem + env(safe-area-inset-top));
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .install-header h1 {
      margin: 0;
      font-size: 1.25rem;
    }
    
    .install-content {
      flex: 1;
      padding: 1.5rem;
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    
    .install-icon-large {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .install-icon-large img {
      width: 96px;
      height: 96px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .install-title {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--pwa-text);
    }
    
    .install-subtitle {
      text-align: center;
      color: var(--pwa-text-muted);
      margin-bottom: 2rem;
    }
    
    .status-card {
      background: var(--pwa-surface);
      border-radius: var(--pwa-radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--pwa-shadow);
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--pwa-border);
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }
    
    .status-icon.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status-icon.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-icon.pending {
      background: #e2e3e5;
      color: #383d41;
    }
    
    .status-text {
      flex: 1;
      font-size: 0.9375rem;
    }
    
    .install-btn-container {
      margin-bottom: 1.5rem;
    }
    
    .install-main-btn {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      border: none;
      border-radius: var(--pwa-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      transition: all 0.2s;
    }
    
    .install-main-btn.primary {
      background: var(--pwa-primary);
      color: #fff;
    }
    
    .install-main-btn.primary:hover {
      background: var(--pwa-primary-dark);
    }
    
    .install-main-btn.success {
      background: var(--pwa-success);
      color: #fff;
    }
    
    .install-main-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .message-box {
      padding: 1rem;
      border-radius: var(--pwa-radius-sm);
      margin-bottom: 1rem;
      display: none;
    }
    
    .message-box.show {
      display: block;
    }
    
    .message-box.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message-box.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message-box.info {
      background: #e6f3f8;
      color: #0a6286;
      border: 1px solid #b8daeb;
    }
    
    .ios-instructions {
      background: var(--pwa-surface);
      border-radius: var(--pwa-radius);
      padding: 1.5rem;
      box-shadow: var(--pwa-shadow);
      display: none;
    }
    
    .ios-instructions.show {
      display: block;
    }
    
    .ios-instructions h3 {
      margin: 0 0 1rem;
      color: var(--pwa-text);
    }
    
    .ios-step {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--pwa-border);
    }
    
    .ios-step:last-child {
      border-bottom: none;
    }
    
    .ios-step-num {
      width: 32px;
      height: 32px;
      background: var(--pwa-primary);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .ios-step-text {
      flex: 1;
    }
    
    .ios-step-text strong {
      display: block;
      margin-bottom: 0.25rem;
    }
    
    .ios-step-text small {
      color: var(--pwa-text-muted);
    }
    
    .share-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #007AFF;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      font-size: 14px;
      vertical-align: middle;
    }
    
    .already-installed {
      text-align: center;
      padding: 2rem;
    }
    
    .already-installed .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="install-page">
  <header class="install-header">
    <button class="back-btn" onclick="history.back()">‚Üê</button>
    <h1>Install App</h1>
  </header>
  
  <main class="install-content">
    <!-- Already Installed View -->
    <div id="installedView" class="already-installed" style="display: none;">
      <div class="icon">‚úÖ</div>
      <h2 class="install-title">App Already Installed!</h2>
      <p class="install-subtitle">You're already using the installed version of this app.</p>
      <button class="install-main-btn primary" onclick="history.back()">
        Go Back
      </button>
    </div>
    
    <!-- Install View -->
    <div id="installView">
      <div class="install-icon-large">
        <img src="/assets/favicon.svg" alt="App Icon" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%230a6286%22 width=%22100%22 height=%22100%22 rx=%2220%22/><text x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22>üì±</text></svg>'">
      </div>
      
      <h2 class="install-title" id="appTitle">Church Fundraising</h2>
      <p class="install-subtitle">Install for quick access and better experience</p>
      
      <!-- Status Checks -->
      <div class="status-card">
        <div class="status-item">
          <span class="status-icon" id="httpsStatus">‚è≥</span>
          <span class="status-text">Secure connection (HTTPS)</span>
        </div>
        <div class="status-item">
          <span class="status-icon" id="swStatus">‚è≥</span>
          <span class="status-text">Service worker registered</span>
        </div>
        <div class="status-item">
          <span class="status-icon" id="manifestStatus">‚è≥</span>
          <span class="status-text">App manifest loaded</span>
        </div>
        <div class="status-item">
          <span class="status-icon" id="promptStatus">‚è≥</span>
          <span class="status-text">Install prompt available</span>
        </div>
      </div>
      
      <!-- Messages -->
      <div class="message-box" id="messageBox"></div>
      
      <!-- Install Button -->
      <div class="install-btn-container">
        <button class="install-main-btn primary" id="installBtn" disabled>
          <span>‚è≥</span>
          <span id="installBtnText">Checking...</span>
        </button>
      </div>
      
      <!-- iOS Instructions -->
      <div class="ios-instructions" id="iosInstructions">
        <h3>How to Install on iOS</h3>
        <div class="ios-step">
          <span class="ios-step-num">1</span>
          <div class="ios-step-text">
            <strong>Tap the Share button</strong>
            <small>Look for <span class="share-icon">‚¨ÜÔ∏è</span> at the bottom of Safari</small>
          </div>
        </div>
        <div class="ios-step">
          <span class="ios-step-num">2</span>
          <div class="ios-step-text">
            <strong>Scroll down and tap "Add to Home Screen"</strong>
            <small>It has a ‚ûï icon next to it</small>
          </div>
        </div>
        <div class="ios-step">
          <span class="ios-step-num">3</span>
          <div class="ios-step-text">
            <strong>Tap "Add" in the top right</strong>
            <small>The app will appear on your home screen</small>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    // Detect platform
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isAndroid = /Android/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;
    
    // State
    let deferredPrompt = null;
    let statusChecks = {
      https: false,
      sw: false,
      manifest: false,
      prompt: false
    };
    
    // DOM elements
    const installedView = document.getElementById('installedView');
    const installView = document.getElementById('installView');
    const installBtn = document.getElementById('installBtn');
    const installBtnText = document.getElementById('installBtnText');
    const messageBox = document.getElementById('messageBox');
    const iosInstructions = document.getElementById('iosInstructions');
    
    // Check if already installed
    if (isStandalone) {
      installedView.style.display = 'block';
      installView.style.display = 'none';
    } else {
      runChecks();
    }
    
    // Run status checks
    async function runChecks() {
      // 1. Check HTTPS
      statusChecks.https = location.protocol === 'https:' || location.hostname === 'localhost';
      updateStatus('httpsStatus', statusChecks.https);
      
      // 2. Check Service Worker
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          statusChecks.sw = registrations.length > 0;
        } catch (e) {
          statusChecks.sw = false;
        }
      }
      updateStatus('swStatus', statusChecks.sw);
      
      // 3. Check Manifest
      const manifestLink = document.querySelector('link[rel="manifest"]') || 
                          parent.document.querySelector('link[rel="manifest"]');
      if (manifestLink) {
        try {
          const response = await fetch(manifestLink.href);
          statusChecks.manifest = response.ok;
        } catch (e) {
          statusChecks.manifest = false;
        }
      }
      updateStatus('manifestStatus', statusChecks.manifest);
      
      // 4. Check if we have install prompt (wait a bit for event)
      setTimeout(() => {
        statusChecks.prompt = deferredPrompt !== null;
        updateStatus('promptStatus', statusChecks.prompt);
        updateButton();
      }, 1500);
    }
    
    function updateStatus(id, success) {
      const el = document.getElementById(id);
      el.className = 'status-icon ' + (success ? 'success' : 'error');
      el.textContent = success ? '‚úì' : '‚úó';
    }
    
    function updateButton() {
      if (isIOS) {
        // iOS - show manual instructions
        installBtn.disabled = false;
        installBtn.innerHTML = '<span>üì±</span><span>See Install Instructions</span>';
        installBtn.onclick = showIOSInstructions;
        showMessage('iOS detected. Tap the button below for install instructions.', 'info');
      } else if (deferredPrompt) {
        // Chrome/Edge - can install automatically
        installBtn.disabled = false;
        installBtn.innerHTML = '<span>üì≤</span><span>Install Now</span>';
        installBtn.onclick = doInstall;
        showMessage('Ready to install! Tap the button below.', 'success');
      } else if (!statusChecks.https) {
        installBtn.disabled = true;
        installBtn.innerHTML = '<span>üîí</span><span>HTTPS Required</span>';
        showMessage('This app can only be installed over a secure HTTPS connection. Please access the site via HTTPS.', 'error');
      } else if (!statusChecks.sw) {
        installBtn.disabled = true;
        installBtn.innerHTML = '<span>‚öôÔ∏è</span><span>Service Worker Missing</span>';
        showMessage('Service worker not found. Try refreshing the page or clearing your cache.', 'error');
      } else {
        // Prompt not available - might already be installed or browser doesn't support
        installBtn.disabled = false;
        installBtn.innerHTML = '<span>üì±</span><span>Add to Home Screen</span>';
        installBtn.onclick = showManualInstructions;
        showMessage('Automatic install not available. Use your browser menu to add this app to your home screen.', 'info');
      }
    }
    
    function showMessage(text, type) {
      messageBox.textContent = text;
      messageBox.className = 'message-box show ' + type;
    }
    
    function showIOSInstructions() {
      iosInstructions.classList.add('show');
      installBtn.style.display = 'none';
      messageBox.style.display = 'none';
    }
    
    function showManualInstructions() {
      let instructions = '';
      
      if (isAndroid) {
        instructions = 'On Android:\n1. Tap the three dots (‚ãÆ) in your browser\n2. Select "Add to Home screen"\n3. Tap "Add"';
      } else {
        instructions = 'In your browser:\n1. Open the browser menu\n2. Look for "Add to Home Screen" or "Install App"\n3. Follow the prompts';
      }
      
      alert(instructions);
    }
    
    async function doInstall() {
      if (!deferredPrompt) {
        showMessage('Install prompt not available. Try refreshing the page.', 'error');
        return;
      }
      
      try {
        installBtn.disabled = true;
        installBtn.innerHTML = '<span>‚è≥</span><span>Installing...</span>';
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          showMessage('App installed successfully! Check your home screen.', 'success');
          installBtn.className = 'install-main-btn success';
          installBtn.innerHTML = '<span>‚úÖ</span><span>Installed!</span>';
        } else {
          showMessage('Installation cancelled. You can try again anytime.', 'info');
          installBtn.disabled = false;
          installBtn.innerHTML = '<span>üì≤</span><span>Install Now</span>';
        }
        
        deferredPrompt = null;
      } catch (error) {
        console.error('Install error:', error);
        showMessage('Installation failed: ' + error.message, 'error');
        installBtn.disabled = false;
        installBtn.innerHTML = '<span>üì≤</span><span>Try Again</span>';
      }
    }
    
    // Listen for install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('Install prompt captured!');
      
      statusChecks.prompt = true;
      updateStatus('promptStatus', true);
      updateButton();
    });
    
    // Listen for successful install
    window.addEventListener('appinstalled', () => {
      console.log('App installed!');
      showMessage('App installed successfully! You can now use it from your home screen.', 'success');
      installBtn.className = 'install-main-btn success';
      installBtn.innerHTML = '<span>‚úÖ</span><span>Installed!</span>';
      installBtn.disabled = true;
    });
    
    // Get app name from referrer
    const referrer = document.referrer;
    if (referrer.includes('/donor/')) {
      document.getElementById('appTitle').textContent = 'Donor Portal';
    } else if (referrer.includes('/registrar/')) {
      document.getElementById('appTitle').textContent = 'Registrar Portal';
    } else if (referrer.includes('/admin/')) {
      document.getElementById('appTitle').textContent = 'Admin Portal';
    }
  </script>
</body>
</html>

